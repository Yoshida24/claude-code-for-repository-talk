name: claude-code

on:
  repository_dispatch:
    types: [claude-query]

jobs:
  claude-query-job:
    runs-on: ubuntu-latest
    if: github.event.action == 'claude-query'
    permissions:
      contents: read
      issues: read # Issueã‚’æ›¸ãå ´åˆã¯write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install Claude CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Execute Claude query
        id: claude-exec
        run: |
          # ã‚¯ã‚¨ãƒªã¨ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—
          QUERY="${{ github.event.client_payload.query }}"
          SYSTEM_PROMPT="${{ github.event.client_payload.system_prompt }}"
          
          echo "ğŸ¤– Claude Query Execution"
          echo "=========================="
          echo "Query: $QUERY"
          echo "System Prompt: $SYSTEM_PROMPT"
          echo ""
          echo "ğŸ”„ Executing Claude query..."
          echo ""

          # Claudeã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
          ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" claude -p "$QUERY" --system-prompt "$SYSTEM_PROMPT" 2>&1 || {
            echo "âŒ Claude command failed"
            exit 1
          }
          
          echo ""
          echo "âœ… Query execution completed!"

      - name: Output completion message
        run: |
          echo ""
          echo "ğŸ‰ Claude query execution finished successfully!"
          echo "Check the logs above for the detailed results."
